<!-- Toast para notificaciones -->
<p-toast></p-toast>

<!-- Header compartido -->
<app-header></app-header>

<!-- Contenido principal -->
<main class="profile-content">
  <div class="content-container">
    <!-- Título de la página -->
    <section class="page-header">
      <h1 class="page-title">Mi Perfil</h1>
      <p class="page-subtitle">Gestiona tu información personal y contraseña</p>
    </section>

    <!-- Grid de secciones -->
    <div class="profile-grid">
      <!-- Sección 1: Información del Perfil -->
      <section class="profile-section">
        <p-card styleClass="profile-card">
          <ng-template pTemplate="header">
            <div class="card-header">
              <div class="header-title">
                <i class="pi pi-user"></i>
                <h2>Información del Perfil</h2>
              </div>
              <div class="header-actions">
                @if (!isEditingProfile()) {
                  <p-button
                    label="Editar Perfil"
                    icon="pi pi-pencil"
                    (onClick)="toggleEditMode()"
                    [disabled]="isLoadingProfile()"
                  ></p-button>
                } @else {
                  <p-button
                    label="Cancelar"
                    icon="pi pi-times"
                    severity="secondary"
                    (onClick)="toggleEditMode()"
                  ></p-button>
                }
              </div>
            </div>
          </ng-template>

          @if (isLoadingProfile()) {
            <!-- Loading state -->
            <div class="loading-state">
              <p-skeleton width="100%" height="60px" styleClass="mb-3"></p-skeleton>
              <p-skeleton width="100%" height="60px" styleClass="mb-3"></p-skeleton>
              <p-skeleton width="100%" height="60px"></p-skeleton>
            </div>
          } @else {
            <!-- Formulario de perfil -->
            <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
              <!-- Campo: Nombre -->
              <div class="form-field">
                <p-floatLabel>
                  <input
                    pInputText
                    id="name"
                    formControlName="name"
                    class="w-full"
                    [class.ng-invalid]="hasProfileError('name')"
                    [class.ng-dirty]="hasProfileError('name')"
                  />
                  <label for="name">Nombre completo</label>
                </p-floatLabel>
                @if (hasProfileError('name')) {
                  <small class="error-message">
                    {{ getProfileErrorMessage('name') }}
                  </small>
                }
              </div>

              <!-- Campo: Email -->
              <div class="form-field">
                <p-floatLabel>
                  <input
                    pInputText
                    id="email"
                    formControlName="email"
                    type="email"
                    class="w-full"
                    [class.ng-invalid]="hasProfileError('email')"
                    [class.ng-dirty]="hasProfileError('email')"
                  />
                  <label for="email">Correo electrónico</label>
                </p-floatLabel>
                @if (hasProfileError('email')) {
                  <small class="error-message">
                    {{ getProfileErrorMessage('email') }}
                  </small>
                }
              </div>

              <!-- Campo: Teléfono -->
              <div class="form-field">
                <p-floatLabel>
                  <input
                    pInputText
                    id="phone"
                    formControlName="phone"
                    class="w-full"
                    [class.ng-invalid]="hasProfileError('phone')"
                    [class.ng-dirty]="hasProfileError('phone')"
                  />
                  <label for="phone">Teléfono (10 dígitos)</label>
                </p-floatLabel>
                @if (hasProfileError('phone')) {
                  <small class="error-message">
                    {{ getProfileErrorMessage('phone') }}
                  </small>
                }
              </div>

              <!-- Botón de guardar (solo visible en modo edición) -->
              @if (isEditingProfile()) {
                <div class="form-actions">
                  <p-button
                    type="submit"
                    label="Guardar Cambios"
                    icon="pi pi-check"
                    [disabled]="!canSaveProfile()"
                    [loading]="isSavingProfile()"
                  ></p-button>
                </div>
              }
            </form>
          }
        </p-card>
      </section>

      <!-- Sección 2: Cambiar Contraseña -->
      <section class="password-section">
        <p-card styleClass="password-card">
          <ng-template pTemplate="header">
            <div class="card-header">
              <div class="header-title">
                <i class="pi pi-lock"></i>
                <h2>Cambiar Contraseña</h2>
              </div>
            </div>
          </ng-template>

          <!-- Formulario de cambio de contraseña -->
          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="password-form">
            <!-- Campo: Contraseña actual -->
            <div class="form-field">
              <p-floatLabel>
                <p-password
                  formControlName="current_password"
                  [toggleMask]="true"
                  [feedback]="false"
                  inputId="current_password"
                  styleClass="w-full"
                  [inputStyleClass]="hasPasswordError('current_password') ? 'ng-invalid ng-dirty w-full' : 'w-full'"
                ></p-password>
                <label for="current_password">Contraseña actual</label>
              </p-floatLabel>
              @if (hasPasswordError('current_password')) {
                <small class="error-message">
                  {{ getPasswordErrorMessage('current_password') }}
                </small>
              }
            </div>

            <!-- Campo: Nueva contraseña -->
            <div class="form-field">
              <p-floatLabel>
                <p-password
                  formControlName="new_password"
                  [toggleMask]="true"
                  [feedback]="true"
                  inputId="new_password"
                  styleClass="w-full"
                  [inputStyleClass]="hasPasswordError('new_password') ? 'ng-invalid ng-dirty w-full' : 'w-full'"
                ></p-password>
                <label for="new_password">Nueva contraseña</label>
              </p-floatLabel>
              @if (hasPasswordError('new_password')) {
                <small class="error-message">
                  {{ getPasswordErrorMessage('new_password') }}
                </small>
              }
            </div>

            <!-- Campo: Confirmar nueva contraseña -->
            <div class="form-field">
              <p-floatLabel>
                <p-password
                  formControlName="confirm_password"
                  [toggleMask]="true"
                  [feedback]="false"
                  inputId="confirm_password"
                  styleClass="w-full"
                  [inputStyleClass]="hasPasswordError('confirm_password') ? 'ng-invalid ng-dirty w-full' : 'w-full'"
                ></p-password>
                <label for="confirm_password">Confirmar nueva contraseña</label>
              </p-floatLabel>
              @if (hasPasswordError('confirm_password')) {
                <small class="error-message">
                  {{ getPasswordErrorMessage('confirm_password') }}
                </small>
              }
            </div>

            <!-- Botón de cambiar contraseña -->
            <div class="form-actions">
              <p-button
                type="submit"
                label="Cambiar Contraseña"
                icon="pi pi-key"
                [disabled]="!canChangePassword()"
                [loading]="isChangingPassword()"
              ></p-button>
            </div>
          </form>
        </p-card>
      </section>
    </div>
  </div>
</main>
